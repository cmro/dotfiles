#!/bin/sh
set -e

echo "[chezmoi] Checking Nix installation..."

if command -v nix >/dev/null 2>&1; then
    echo "[chezmoi] Nix already installed."
    exit 0
fi

OS="$(uname -s)"
ARCH="$(uname -m)"

# Container-Detection
is_container() {
    [ -f "/.dockerenv" ] && return 0
    grep -qaE 'container|docker' /proc/1/cgroup 2>/dev/null && return 0
    return 1
}

echo "[chezmoi] Detected OS: $OS, Arch: $ARCH, IsContainer: $(is_container)"

VERSION={{ (gitHubLatestTag "NixOS/nix").Name }}
INSTALLER="https://releases.nixos.org/nix/nix-${VERSION}/install"

if is_container; then
    echo "[chezmoi] Container detected → single-user install"
    curl -L "$INSTALLER" | sh -s -- --no-daemon --no-modify-profile
else
    echo "[chezmoi] Host system → no nix installation"
    exit 0
fi

echo "[chezmoi] Nix installation complete."
